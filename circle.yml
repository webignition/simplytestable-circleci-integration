machine:
  php:
    version: 5.5.36
  environment:
    SYMFONY_ENV: prod

dependencies:
  cache_directories:
    - ~/.composer/cache

  pre:
    - echo "date.timezone = Europe/London" >> /opt/circleci/php/$(phpenv global)/etc/php.ini

  override:
    # Check out worker repo
    - git clone git@github.com:webignition/worker.simplytestable.com.git
    # Create app config
    - cp config/worker.simplytestable.com/app_parameters.yml worker.simplytestable.com/app/config/parameters.yml
    # Create bundle config
    - cp worker.simplytestable.com/app/config/security_credentials.yml.dist worker.simplytestable.com/app/config/security_credentials.yml
    - cat config/worker.simplytestable.com/bundle_parameters.yml config/worker.simplytestable.com/bundle_parameters.hydrogen > worker.simplytestable.com/src/SimplyTestable/WorkerBundle/Resources/config/parameters.yml
    # Create database and database user
    - mysql -u ubuntu < config/worker.simplytestable.com/createdb.sql
    # Install
    - rm -rf app/cache/*
    - composer install:
        pwd: worker.simplytestable.com

database:
  override:
    - php app/console doctrine:database:create:
        pwd: worker.simplytestable.com
    - php app/console doctrine:migrations:migrate --no-interaction:
        pwd: worker.simplytestable.com
    - mysql -u ubuntu < config/worker.simplytestable.com/insert_core_application.sql

test:
  pre:
   - php app/console simplytestable:worker:activate:
       pwd: worker.simplytestable.com
  override:
    - echo foo
